{% extends 'base.html' %}
{% block content %}

<style>
  #exam-form > div > label {
    display: inline-block;
    width: 200px;
    text-align: right;
    margin-right: 10px;
  }
</style>

{% raw %}<div id="exam-app">
  <form id="exam-form" @submit.prevent="gradeExam">
    <div>
      <label for="yaml-select"><strong>Question set:</strong></label>
      <select id="yaml-select" v-model="selectedYaml" @change="resetExam">
        <option disabled selected value="">-- Select a question set --</option>
        <option v-for="file in yamlFiles" :key="file" :value="file">[[ file ]]</option>
      </select>
    </div>
    <div>
      <label for="name"><strong>Name:</strong></label>
      <input id="name" v-model="studentName" type="text" required placeholder="Your full name; e.g. John Smith" />
    </div>
    <div>
      <label for="max-points"><strong>Max Points:</strong></label>
      <input id="max-points" v-model.number="maxPoints" type="number" min="1" max="200" required />
    </div>
    <div>
      <label for="max-difficulty"><strong>Max difficult question:</strong></label>
      <input id="max-difficulty" v-model.number="maxDifficulty" type="number" min="1" max="20" required />
    </div>
    <div>
      <button type="button" @click="startExam" :disabled="!canStart">Start Exam</button>
    </div>

    <div v-if="started" style="margin-top: 2em;">
      <div>
        <h2>Quiz for [[ studentName ]]</h2>
        <div>[[ examDate ]]</div>
        <div>
          [[ questions.length ]] questions for a total of [[ totalPoints ]] points.
        </div>
        <div v-if="history && history.length">
          <div v-for="(row, idx) in history" :key="'history-' + idx">[[ row ]]</div>
        </div>
      </div>
      <hr>
      <div v-for="(q, qIdx) in questions" :key="'q-'+qIdx" style="margin-bottom:1.5em;">
        <h3>Q[[ qIdx+1 ]]. [[ q.question ]] ([[ q.points ]] pts)</h3>
        <div v-for="(ans, aIdx) in q.displayAnswers" :key="ans.uid">
          <label>
            <input type="checkbox"
                   :id="ans.uid"
                   :name="'q-' + qIdx"
                   :value="ans.uid"
                   v-model="answers[qIdx]"
                   @change="answerChanged(qIdx, aIdx, ans.isNoneOfTheAbove)">
            [[ ans.answer ]]
          </label>
        </div>
      </div>
      <button type="submit" :disabled="!readyToGrade">Grade Quiz</button>
    </div>
  </form>
  <div v-if="results">
    <h3>Results</h3>
    <div>
      Name: [[ results.name ]]<br>
      Score: [[ results.score ]] / [[ results.maxPoints ]]<br>
      Max Difficulty: [[ results.maxDifficulty ]]<br>
      <div v-if="results.answers">
        <div v-for="(ans, idx) in results.answers" :key="'result-'+idx">
          <strong>Q[[ idx+1 ]]:</strong>
          <span v-if="ans.right" style="color:green;">Right</span>
          <span v-else style="color:red;">Wrong</span>
        </div>
      </div>
    </div>
  </div>
</div>{% endraw %}

<script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xxhashjs@0.2.2/build/xxhash.min.js"></script>
<script>
var yamlFiles = [];
{% for file in model.yamlFiles %}
yamlFiles.push('{{ file }}');
{% endfor %}
new Vue({
  el: '#exam-app',
  delimiters: ['[[', ']]'],
  data: {
    yamlFiles: yamlFiles,
    selectedYaml: '',
    studentName: localStorage.getItem('studentName') || '',
    maxPoints: 50,
    maxDifficulty: 7,
    started: false,
    allQuestions: [],
    questions: [],
    answers: [],
    history: [],
    examDate: '',
    totalPoints: 0,
    results: null,
    secret: 'exam_secret_key',  // For hashing IDs
  },
  watch: {
    studentName(newName) {
      localStorage.setItem('studentName', newName);
    }
  },
  computed: {
    canStart() {
      return this.selectedYaml && this.studentName && this.maxPoints && this.maxDifficulty;
    },
    readyToGrade() {
      if (!this.questions.length) return false;
      // All questions must have at least one checked value
      return this.answers.length === this.questions.length && this.answers.every(arr => arr && arr.length > 0);
    }
  },
  methods: {
    resetExam() {
      this.started = false;
      this.allQuestions = [];
      this.questions = [];
      this.answers = [];
      this.history = [];
      this.examDate = '';
      this.totalPoints = 0;
      this.results = null;
    },
    initYamlSelection() {
      // Set the first yaml file as the default selection if not already set
      if (!this.selectedYaml && this.yamlFiles.length) {
        this.selectedYaml = this.yamlFiles[0];
      }
    },
    startExam() {
      if (!this.canStart) return;
      this.results = null;
      this.started = false;
      this.answers = [];
      this.questions = [];
      this.history = [];
      this.examDate = new Date().toISOString().slice(0,10);

      // POST to API for exam generation
      axios.post('/startexam', {
        selectedYaml: this.selectedYaml,
        maxPoints: this.maxPoints,
        maxDifficulty: this.maxDifficulty
      })
        .then(res => {
          this.questions = res.data.questions || [];
          this.totalPoints = res.data.totalPoints || 0;
          this.history = res.data.history || [];
          this.answers = Array(this.questions.length).fill().map(()=>[]);
          this.started = true;
        })
        .catch(e => {
          alert("Failed to start exam: " + (e.response?.data?.error || e.message));
        });
    },
    answerChanged(qIdx, aIdx, isNoneOfTheAbove) {
      // If "None of the above" is checked, uncheck others and vice versa
      let anArr = this.answers[qIdx] || [];
      let q = this.questions[qIdx];
      let noneIdx = q.displayAnswers.findIndex(a => a.isNoneOfTheAbove);
      if (noneIdx === -1) return;
      let noneUid = q.displayAnswers[noneIdx].uid;

      // If "None of the above" is being selected, set to only that
      if (this.answers[qIdx].includes(noneUid)) {
        this.answers[qIdx] = [noneUid];
      } else {
        // If any other checkbox is checked, uncheck "None of the above"
        this.answers[qIdx] = this.answers[qIdx].filter(uid => uid !== noneUid);
      }
      // Always update to force Vue reactivity
      this.$set(this.answers, qIdx, this.answers[qIdx]);
    },
    gradeExam() {
      // Gather answers and post to /gradeexam
      let answerObjs = [];
      for (let qi=0; qi<this.questions.length; ++qi) {
        let q = this.questions[qi];
        let selUids = this.answers[qi] || [];
        let selectedAnswers = q.displayAnswers.filter(a => selUids.includes(a.uid));
        // We'll just say "right" if at least one selection is a correct answer, else wrong
        let isRight = selectedAnswers.some(a => a.isRight);
        answerObjs.push({
          selected: selUids,
          right: isRight,
          points: q.points
        });
      }
      axios.post('/gradeexam', {
        name: this.studentName,
        maxPoints: this.totalPoints,
        maxDifficulty: this.maxDifficulty,
        history: this.history,
        answers: answerObjs
      })
      .then(res => {
        this.results = res.data.results || res.data;
        this.started = false;
      })
      .catch(e => {
        alert("Error submitting exam: " + e);
      });
    }
  },
  mounted() {
    this.initYamlSelection();
  }
});
</script>


{% endblock %}