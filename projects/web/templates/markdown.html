{% extends 'base.html' %}
{% block content %}

<style>
  /* Prevent markdown content from sliding under the nav in desktop mode */
  @media (min-width: 768px) {
    #markdown-container {
      display: flex;
      flex-direction: row;
      align-items: flex-start;
      width: 100%;
    }
    #markdown-toc {
      position: fixed !important;
      top: 60px !important;
      left: 0 !important;
      width: 320px;
      height: calc(100vh - 60px);
      z-index: 1020;
      background: #fff;
      border-right: 1px solid #ddd;
      padding: 1em 1em 1em 0.5em;
      overscroll-behavior: contain;
      pointer-events: auto;
    }
    #markdown-content {
      margin-left: 330px !important;
      max-width: calc(100vw - 330px);
      min-width: 0;
      width: 100%;
      transition: margin-left 0.25s cubic-bezier(.4,0,.2,1);
    }
    /* TOC links cursor and pointer in desktop */
    #markdown-toc a {
      pointer-events: auto;
      color: #007bff;
      cursor: pointer;
      text-decoration: underline;
    }
    #markdown-toc a:hover {
      text-decoration: underline;
      color: #0056b3;
      cursor: pointer;
    }
  }
  @media (max-width: 767.98px) {
    #markdown-container {
      display: block;
      width: 100%;
    }
    #markdown-content {
      margin-left: 0 !important;
      max-width: 100vw;
      width: 100%;
    }
    #markdown-toc {
      /* Ensure TOC drawer sits ABOVE overlay on mobile */
      z-index: 1205 !important;
      background: #fff;
      width: 100vw;
      left: 0 !important;
      position: fixed !important;
      top: 60px !important;
      height: auto !important;
      /* Allow interaction in mobile drawer */
      pointer-events: auto;
    }
    #markdown-toc ul,
    #markdown-toc ol {
      pointer-events: auto;
    }
    /* Optionally, allow pointer events for just the close button if such exists */
    #markdown-toc .toc-close-btn {
      pointer-events: auto;
    }
    /* Enable clickable TOC links in mobile */
    #markdown-toc a {
      pointer-events: auto;
      color: #007bff !important;
      cursor: pointer !important;
      text-decoration: underline !important;
    }
    #markdown-toc a:hover {
      color: #0056b3 !important;
      cursor: pointer !important;
      text-decoration: underline !important;
    }
  }

  /* --- Scroll target fix for hamburger/contents menu --- */
  .markdown-anchor-target {
    display: block;
    position: relative;
    top: -65px;
    visibility: hidden;
    height: 1px;
    width: 1px;
    pointer-events: none;
  }
</style>
<script>
// Fix: On mobile, keep TOC visible after click so scroll lands at right location, then close TOC AFTER scroll
document.addEventListener("DOMContentLoaded", function() {
  var toc = document.getElementById("markdown-toc");
  if (toc) {
    toc.addEventListener("click", function(e) {
      // Prevent clicks inside TOC from bubbling to overlays/toggles
      e.stopPropagation();
      if (typeof e.stopImmediatePropagation === "function") e.stopImmediatePropagation();
      let tgt = e.target;
      while (tgt && tgt !== toc && tgt.tagName !== "A") tgt = tgt.parentElement;
      if (tgt && tgt.tagName === "A" && tgt.hash && tgt.getAttribute("href").startsWith("#")) {
        // Only prevent default on mobile so you can control scroll and nav closing!
        if (window.innerWidth < 768) {
          e.preventDefault();
          let hash = tgt.hash;
          // scroll first
          scrollToHash(hash, true);
          // Optionally update location.hash without native jump
          if(history.replaceState){
            history.replaceState(null, null, hash);
          } else {
            location.hash = hash;
          }
          // Wait a tick for scroll, THEN hide menu
          setTimeout(function(){
            var navmenu = document.getElementById("markdown-toc");
            if (navmenu) {
              navmenu.classList.remove('open');
            }
            document.body.classList.remove('toc-overlay-active');
          }, 350); // allow scroll to start before closing
        }
        // Desktop: let normal browser action occur
      }
    });
  }
});
</script>
<script>
  // Patch: always handle TOC anchor clicks, especially in mobile/hamburger mode
  document.addEventListener("DOMContentLoaded", function() {
    // Delegate click handler to markdown-toc for TOC links
    var toc = document.getElementById("markdown-toc");
    if (toc) {
      toc.addEventListener("click", function(e) {
        // Keep click inside the drawer
        e.stopPropagation();
        if (typeof e.stopImmediatePropagation === "function") e.stopImmediatePropagation();
        let tgt = e.target;
        // Find nearest <a> (for clicks on inner spans)
        while (tgt && tgt !== toc && tgt.tagName !== "A") tgt = tgt.parentElement;
        if (tgt && tgt.tagName === "A" && tgt.hash && tgt.getAttribute("href").startsWith("#")) {
          e.preventDefault();
          let hash = tgt.hash;
          // Scroll
          scrollToHash(hash, true);
          // Optionally update location.hash without native jump
          if(history.replaceState){
            history.replaceState(null, null, hash);
          } else {
            location.hash = hash;
          }
          // Defer closing to allow smooth scroll first
          if (window.innerWidth < 768) {
            setTimeout(function(){
              var navmenu = document.getElementById("markdown-toc");
              if (navmenu) navmenu.classList.remove('open');
              document.body.classList.remove('toc-overlay-active');
            }, 350);
          }
        }
      });
    }
  });
</script>
<script>
  // Insert anchor targets before major markdown headers (h1/h2/h3...) after DOMContentLoaded
  document.addEventListener("DOMContentLoaded", function() {
    // Add anchors for all headers with id (as generated by markdown)
    const headings = document.querySelectorAll('h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]');
    headings.forEach(function(header) {
      // Avoid dual anchors if already present
      if (header.previousElementSibling && header.previousElementSibling.classList && header.previousElementSibling.classList.contains('markdown-anchor-target')) return;
      let a = document.createElement('span');
      a.className = "markdown-anchor-target";
      a.id = header.id; // set anchor id to match header id
      
      // Move id from header to anchor for best compatibility (prevents double scrolling in some browsers)
      header.removeAttribute('id');
      header.parentNode.insertBefore(a, header);
    });
  });
</script>
<script>
// iOS browsers do not reliably scroll to hashes by default when UI overlays
// Add robust scroll-to-anchor support for TOC links on mobile and iOS

function scrollToHash(hash, smooth=true) {
  if (!hash) return;
  // Remove leading "#"
  var id = hash.charAt(0) === '#' ? hash.slice(1) : hash;
  var el = document.getElementById(id);
  if (!el) return;
  // Consider offset for fixed nav/top bars -- adjust as needed
  var offset = 65; // matches nav/top bar height
  var rect = el.getBoundingClientRect();
  var scrollTop = window.pageYOffset || document.documentElement.scrollTop;

  // Prefer scrollIntoView if supported and safe
  if (typeof el.scrollIntoView === "function") {
    // Some browsers (iOS Safari/Chrome) require delay before scrolling
    setTimeout(() => {
      el.scrollIntoView({ behavior: smooth ? "smooth" : "auto", block: "start", inline: "nearest" });
      // Then nudge a bit if offset needed for fixed nav
      // If still covered, do direct scroll adjustment
      var actualY = el.getBoundingClientRect().top + window.scrollY - offset;
      window.scrollTo({ top: actualY, behavior: smooth ? "smooth" : "auto" });
    }, 30);
  } else {
    // Fallback
    window.scrollTo({ top: rect.top + scrollTop - offset, behavior: smooth ? "smooth" : "auto" });
  }
}

// Click handler for all TOC links to force scroll on mobile/iOS
document.addEventListener("DOMContentLoaded", function() {
  // For hash present in URL at load (direct link)
  if (window.location.hash) {
    // On iOS/Safari, the jump doesn't always occur, so force it
    setTimeout(function() {
      scrollToHash(window.location.hash, false);
    }, 100);
  }

  // Attach click handlers to TOC links
  document.getElementById('toc-list')?.addEventListener('click', function(e) {
    if (e.target && e.target.matches("a.nav-link, a")) {
      // Prevent bubbling to overlay or page handlers
      e.stopPropagation();
      if (typeof e.stopImmediatePropagation === "function") e.stopImmediatePropagation();
      var href = e.target.getAttribute("href");
      if (href && href.startsWith("#")) {
        e.preventDefault();
        // Update hash in location bar (so it still updates)
        history.pushState(null, '', href);
        scrollToHash(href, true);
        // Auto-close drawer after navigation on mobile
        if (window.matchMedia("(max-width: 767.98px)").matches) {
          setTimeout(function(){
            var navmenu = document.getElementById("markdown-toc");
            if (navmenu) navmenu.classList.remove('open');
            document.body.classList.remove('toc-overlay-active');
          }, 350);
        }
      }
    }
  });

  // Respond to hashchange events (e.g. manual nav, browser back/forward)
  window.addEventListener("hashchange", function(evt) {
    scrollToHash(window.location.hash, true);
  }, false);
});
</script>
<div id="markdown-container">
  <!-- TOC Toggle Button: fixed in upper left for mobile only -->
  <button id="toc-toggle-btn"
          class="btn btn-outline-secondary d-md-none"
          style="position: fixed; top: 62px; left: 8px; z-index: 1205; width: auto; min-width: 44px; min-height: 44px; padding: 0.5em 1em; box-shadow: 0 2px 8px #0002;">
    <span id="toc-toggle-icon">&#9776;</span>
    <span style="font-size: 14px; margin-left: 4px;">Contents</span>
  </button>
  <!-- Responsive Left Navigation Panel for Mobile -->
  <nav id="markdown-toc"
       style="position: fixed; left: 0; top: 60px; width: 320px; border-right: 1px solid #ddd; padding: 1em 1em 1em 0.5em; max-height: 88vh; overflow-y: auto; background: #fff; z-index: 1020; pointer-events:auto; transition: transform 0.2s ease; box-shadow: 0 2px 10px #0001;">
    <h5 class="d-none d-md-block">Page Contents</h5>
    <ul class="nav flex-column" id="toc-list" style="gap: 0; padding-left: 0; margin-bottom: 0; margin-left:0;"></ul>
    <style>
      #markdown-toc {
        margin-left: 0 !important;
        padding-left: 0.5em !important;
        left: 0 !important;
        top: 60px !important;
        position: fixed !important;
        width: 320px;
        z-index: 1020;
        background: #fff;
        transition: transform 0.25s cubic-bezier(.4,0,.2,1);
      }
      #markdown-toc ul#toc-list {
        margin-left: 0 !important;
        padding-left: 0 !important;
      }
      #markdown-toc ul#toc-list > li {
        margin-bottom: 2px !important;
        padding-bottom: 0 !important;
        padding-top: 0 !important;
        margin-left: 0 !important;
      }
      #markdown-toc ul#toc-list li a.nav-link {
        padding-top: 2px !important;
        padding-bottom: 2px !important;
        font-size: 1em;
        margin-left: 0 !important;
      }
      #markdown-toc ul#toc-list ul {
        margin-top: 0 !important;
        margin-bottom: 0 !important;
        gap: 0;
        margin-left: 0 !important;
        padding-left: 0 !important;
      }
      /* Desktop: keep nav visible and fixed */
      @media (min-width: 768px) {
        #markdown-toc {
          transform: translateX(0) !important;
          box-shadow: none;
        }
        /* #markdown-content margin now handled by parent container! */
        #toc-toggle-btn { display: none !important; }
      }
      /* Mobile/tablet: hide nav off-canvas by default, overlay when open */
      @media (max-width: 767.98px) {
        #markdown-toc {
          width: 85vw;
          max-width: 350px;
          min-width: 205px;
          transform: translateX(-105%);
          box-shadow: 2px 0 18px 0 rgba(80,60,120,0.22);
          border-right: none;
          border-bottom: 1px solid #ddd;
          height: calc(98vh - 52px);
          max-height: none;
        }
        #markdown-toc.open {
          transform: translateX(0);
        }
        body.toc-overlay-active #markdown-toc {
          /* ensure it's above everything when open */
          z-index: 1202;
        }
        #markdown-toc h5.d-none.d-md-block {
          display: none !important;
        }
        #markdown-toc .close-toc-btn {
          display: inline-block;
        }
        /* Position floating open button */
        #toc-toggle-btn {
          display: block !important;
        }
      }
      /* Overlay background when menu open (mobile only) */
      #toc-overlay-bg {
        display: none;
      }
      @media (max-width: 767.98px) {
        #toc-overlay-bg {
          display: none;
          position: fixed;
          z-index: 1201;
          top: 0;
          left: 0;
          width: 100vw;
          height: 100vh;
          background: rgba(40, 30, 10, 0.25);
        }
        body.toc-overlay-active #toc-overlay-bg {
          display: block;
          /* Do not intercept clicks; TOC handles its own clicks */
          pointer-events: none !important;
        }
      }
    </style>
    <!-- close button for mobile, appears inside nav -->
    <button class="btn btn-link close-toc-btn d-md-none"
            aria-label="Close navigation"
            style="position: absolute; right: 1em; top: 1em; font-size: 1.5em; display: none;">&times;</button>
  </nav>
  <!-- Mobile overlay background for drawer TOC -->
  <div id="toc-overlay-bg"></div>
  <script>
    // Responsive nav logic: for small screens, show/hide TOC as a drawer.
    (function() {
      var tocNav = document.getElementById('markdown-toc');
      var toggleBtn = document.getElementById('toc-toggle-btn');
      var overlayBg = document.getElementById('toc-overlay-bg');
      var closeBtn = tocNav.querySelector('.close-toc-btn');

      function openToc() {
        tocNav.classList.add('open');
        document.body.classList.add('toc-overlay-active');
        // Hide toggle button while nav is open (on mobile)
        if (toggleBtn && isMobile()) {
          toggleBtn.style.visibility = "hidden";
          toggleBtn.style.pointerEvents = "none";
          toggleBtn.style.display = "none";
        }
      }
      function closeToc() {
        tocNav.classList.remove('open');
        document.body.classList.remove('toc-overlay-active');
        if (toggleBtn && isMobile()) {
          toggleBtn.style.display = "block";
          toggleBtn.style.visibility = "visible";
          toggleBtn.style.pointerEvents = "auto";
        }
      }
      // Expose for other inline handlers to use
      window.__closeToc = closeToc;
      // Only activate if mobile
      function isMobile() {
        return window.matchMedia("(max-width: 767.98px)").matches;
      }
      if (toggleBtn) {
        toggleBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          if (tocNav.classList.contains('open')) {
            closeToc();
          } else {
            openToc();
          }
        });
      }
      if (closeBtn) {
        closeBtn.addEventListener('click', function(e) {
          e.preventDefault();
          closeToc();
        });
      }
      // Close toc when clicking outside of it (on overlay)
      if (overlayBg) {
        overlayBg.addEventListener('click', function() {
          closeToc();
        });
      }
      // Escape key closes on mobile
      document.addEventListener('keydown', function(e) {
        if (isMobile() && tocNav.classList.contains('open') && (e.key === "Escape" || e.keyCode === 27)) {
          closeToc();
        }
      });
      // If user resizes window, close drawer if switching to desktop
      window.addEventListener('resize', function() {
        if (!isMobile()) {
          closeToc();
        }
      });

      // On load, hide floating button on desktop, ensure visible on mobile (if nav is closed)
      function adjustToggleBtn() {
        if (toggleBtn) {
          if (isMobile()) {
            if (!tocNav.classList.contains('open')) {
              toggleBtn.style.visibility = "visible";
            }
          } else {
            toggleBtn.style.visibility = "hidden";
          }
        }
      }
      adjustToggleBtn();
      window.addEventListener("resize", adjustToggleBtn);
    })();
  </script>

  <!-- Main Content -->
  <div id="markdown-content" style="width: 100%; height: 100%; flex: 1 1 auto; margin-left: 0; padding-right: 0;">
    {{ model.Markdown(model.data) | safe }}
  </div>
</div>
<script>
document.addEventListener("DOMContentLoaded", function() {
  function slugify(text) {
    // Convert heading text to URL slug for ids
    return text.toString().toLowerCase()
      .replace(/[^a-z0-9\s\-]/g, '')     // Remove non-alphanumeric, non-space, non-hyphen
      .replace(/\s+/g, '-')              // Convert spaces to hyphens
      .replace(/\-+/g, '-')              // Merge multiple hyphens
      .replace(/^\-+|\-+$/g, '');        // Trim hyphens
  }
  // Find all headers in the markdown content
  const content = document.getElementById("markdown-content");
  if (!content) return;
  const headings = content.querySelectorAll("h1, h2, h3");
  const tocList = document.getElementById("toc-list");
  if (!tocList || !headings.length) return;
  // Ensure we start fresh
  tocList.innerHTML = "";

  let lastLevel1 = null, lastLevel2 = null;
  headings.forEach(function(header) {
    // Ensure the header has an id
    if (!header.id) {
      header.id = slugify(header.textContent);
    }
    const item = document.createElement("li");
    item.classList.add("nav-item");
    let a = document.createElement("a");
    a.className = "nav-link";
    a.href = "#" + header.id;
    a.textContent = header.textContent;
    // Structure TOC according to header level
    if (header.tagName === "H1") {
      item.style.marginLeft = "0px";
      item.appendChild(a);
      tocList.appendChild(item);
      lastLevel1 = item;
      lastLevel2 = null;
    } else if (header.tagName === "H2") {
      item.style.marginLeft = "16px";
      item.appendChild(a);
      // nest under last H1
      let ul;
      if (lastLevel1) {
        ul = lastLevel1.querySelector("ul");
        if (!ul) {
          ul = document.createElement("ul");
          ul.className = "nav flex-column";
          ul.style.paddingLeft = "0";
          lastLevel1.appendChild(ul);
        }
        ul.appendChild(item);
      } else {
        tocList.appendChild(item);
      }
      lastLevel2 = item;
    } else if (header.tagName === "H3") {
      item.style.marginLeft = "32px";
      item.appendChild(a);
      // nest under last H2
      let ul;
      if (lastLevel2) {
        ul = lastLevel2.querySelector("ul");
        if (!ul) {
          ul = document.createElement("ul");
          ul.className = "nav flex-column";
          ul.style.paddingLeft = "0";
          lastLevel2.appendChild(ul);
        }
        ul.appendChild(item);
      } else if (lastLevel1) {
        // if no H2, nest under H1
        let ul = lastLevel1.querySelector("ul");
        if (!ul) {
          ul = document.createElement("ul");
          ul.className = "nav flex-column";
          ul.style.paddingLeft = "0";
          lastLevel1.appendChild(ul);
        }
        ul.appendChild(item);
      } else {
        tocList.appendChild(item);
      }
    }
  });
});
</script>

 

{% endblock %}